# Splicer Preview Orchestrator

Backend control plane for ephemeral GitHub repository previews. This service creates isolated preview environments for GitHub repositories, enabling live previews that can be embedded in iframes.

## Features

- **Session Management**: Create, monitor, and cleanup preview sessions via REST API
- **Repository Cloning**: Secure cloning of public and private GitHub repositories
- **Dependency Installation**: Auto-detection of package manager (npm, yarn, pnpm)
- **Dev Server Management**: Automatic startup with port allocation and health monitoring
- **Preview Proxying**: HTTP and WebSocket proxying with HMR support
- **Session Lifecycle**: Configurable timeouts (idle, max lifetime, startup)
- **Multi-instance Support**: Session affinity with graceful failover
- **Cloud Logging**: Structured JSON logging for Google Cloud

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloud Run Instance                        │
│  ┌───────────────┐    ┌──────────────┐    ┌──────────────────┐  │
│  │   FastAPI     │───▶│   Session    │───▶│    Workspace     │  │
│  │   HTTP API    │    │   Manager    │    │    Manager       │  │
│  └───────┬───────┘    └──────┬───────┘    └──────────────────┘  │
│          │                   │                                   │
│          │            ┌──────┴───────┐    ┌──────────────────┐  │
│          │            │   Process    │───▶│   Dev Server     │  │
│          │            │   Manager    │    │   (port 3xxx)    │  │
│          │            └──────────────┘    └──────────────────┘  │
│          │                                         ▲             │
│          │            ┌──────────────┐             │             │
│          └───────────▶│    Proxy     │─────────────┘             │
│                       │   Service    │                           │
│                       └──────────────┘                           │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────────────┐
                    │     Supabase     │
                    │  (Session Store) │
                    └──────────────────┘
```

## API Endpoints

### Health & Readiness

| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Liveness check |
| GET | `/ready` | Readiness check |

### Session Management

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/sessions` | Create a new preview session |
| GET | `/api/sessions/{id}` | Get session status |
| DELETE | `/api/sessions/{id}` | Stop and cleanup session |
| GET | `/api/sessions` | List active sessions |

### Preview Access

| Method | Path | Description |
|--------|------|-------------|
| * | `/preview/{session_id}/{path}?token={token}` | Proxy requests to dev server |
| WS | `/preview/{session_id}/{path}?token={token}` | WebSocket proxy (for HMR) |

## Session Lifecycle

1. **pending** - Session created, setup starting
2. **cloning** - Cloning the repository
3. **installing** - Installing dependencies
4. **starting** - Starting the dev server
5. **ready** - Preview is accessible
6. **failed** - Setup failed (check `error_message`)
7. **stopped** - Session terminated

## Configuration

Environment variables (injected via Cloud Run secrets):

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `SUPABASE_URL` | Yes | - | Supabase project URL |
| `SUPABASE_SECRET_KEY` | Yes | - | Supabase secret API key |
| `ENVIRONMENT` | No | `production` | Environment name |
| `SESSION_IDLE_TIMEOUT` | No | `600` | Idle timeout in seconds |
| `SESSION_MAX_LIFETIME` | No | `3600` | Max session lifetime in seconds |
| `SESSION_STARTUP_TIMEOUT` | No | `180` | Startup timeout in seconds |
| `PORT_RANGE_START` | No | `3000` | Start of port range |
| `PORT_RANGE_END` | No | `4000` | End of port range |
| `MAX_CONCURRENT_SESSIONS` | No | `5` | Max sessions per instance |
| `USE_SUBDOMAIN_ROUTING` | No | `false` | Enable subdomain-based preview URLs |
| `PREVIEW_DOMAIN` | No | - | Base domain for subdomains (e.g., `preview.example.com`) |

**Note:** GitHub authentication for private repos is handled per-session via `github_token` in the request body, not via environment variables. Tokens are generated by the frontend using GitHub App installations.

## Database Schema

The service uses Supabase for session persistence. Create this table:

```sql
CREATE TABLE preview_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_activity_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  deleted_at TIMESTAMPTZ, -- Soft delete
  
  repo_owner TEXT NOT NULL,
  repo_name TEXT NOT NULL,
  repo_ref TEXT NOT NULL DEFAULT 'main',
  
  status TEXT NOT NULL DEFAULT 'pending',
  error_message TEXT,
  
  internal_port INTEGER,
  container_instance TEXT,
  
  access_token TEXT NOT NULL UNIQUE,
  
  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'cloning', 'installing', 'starting', 'ready', 'failed', 'stopped')
  )
);

-- Indexes
CREATE INDEX idx_sessions_status ON preview_sessions(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_sessions_expires_at ON preview_sessions(expires_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_sessions_access_token ON preview_sessions(access_token) WHERE deleted_at IS NULL;
CREATE INDEX idx_sessions_container_instance ON preview_sessions(container_instance) WHERE deleted_at IS NULL;

-- Enable RLS
ALTER TABLE preview_sessions ENABLE ROW LEVEL SECURITY;
```

## Local Development

### Prerequisites

- Python 3.12+
- Docker
- Node.js 20+ (for testing previews)

### Setup

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # or `venv\Scripts\activate` on Windows

# Install dependencies
pip install -r requirements.txt

# Set environment variables
export SUPABASE_URL="your-supabase-url"
export SUPABASE_SECRET_KEY="your-secret-key"
export ENVIRONMENT="development"

# Run the server
python -m uvicorn src.main:app --reload --port 8080
```

### Running Tests

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src --cov-report=html

# Run specific test file
pytest tests/test_security.py -v
```

## Deployment

### Prerequisites

1. Google Cloud project with Cloud Run enabled
2. Artifact Registry repository
3. Secrets in Secret Manager:
   - `SUPABASE_URL`
   - `SUPABASE_SECRET_KEY`
4. (For subdomain routing) Load balancer and wildcard SSL certificate - see `infrastructure/terraform/README.md`

### Deploy with Subdomain Routing (Production)

This is the recommended deployment for production. It enables subdomain-based preview URLs 
(`{session_id}.preview.yourdomain.com`) which properly support Vite HMR and JavaScript imports.

```bash
cd /Users/adamblackman/Desktop/Projects/Splicer/splicer-webcontainer

USE_SUBDOMAIN_ROUTING=true PREVIEW_DOMAIN=preview.spliceronline.com ./scripts/deploy.sh splicer-484117 us-east5
```

**Environment variables:**
- `USE_SUBDOMAIN_ROUTING=true` - Enables subdomain-based routing
- `PREVIEW_DOMAIN=preview.spliceronline.com` - The base domain for preview subdomains

### Deploy with Path-Based Routing (Development/Testing)

For development or when subdomain infrastructure isn't available:

```bash
# Make scripts executable
chmod +x scripts/*.sh

# Build and deploy
./scripts/deploy.sh YOUR_PROJECT_ID us-central1 splicer-webcontainer
```

### Manual Deployment

```bash
# Build image
docker build -t gcr.io/YOUR_PROJECT/preview-orchestrator .

# Push to registry
docker push gcr.io/YOUR_PROJECT/preview-orchestrator

# Deploy to Cloud Run
gcloud run deploy preview-orchestrator \
  --image gcr.io/YOUR_PROJECT/preview-orchestrator \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 2 \
  --session-affinity \
  --set-secrets="SUPABASE_URL=SUPABASE_URL:latest,SUPABASE_SECRET_KEY=SUPABASE_SECRET_KEY:latest"
```

## Usage Example

### Create a Preview Session

```bash
# Public repository (no token needed)
curl -X POST https://your-service.run.app/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "repo_owner": "facebook",
    "repo_name": "react",
    "repo_ref": "main"
  }'

# Private repository (requires github_token from GitHub App installation)
curl -X POST https://your-service.run.app/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "repo_owner": "my-org",
    "repo_name": "private-repo",
    "repo_ref": "main",
    "github_token": "ghs_xxxxxxxxxxxx"
  }'
```

Response:
```json
{
  "session": {
    "id": "abc123...",
    "status": "pending",
    "repo_owner": "facebook",
    "repo_name": "react",
    "repo_ref": "main",
    "created_at": "2024-01-15T10:00:00Z",
    "expires_at": "2024-01-15T11:00:00Z",
    "preview_url": null
  },
  "message": "Session created. Setup in progress."
}
```

### Poll for Status

```bash
curl https://your-service.run.app/api/sessions/abc123...
```

When ready:
```json
{
  "id": "abc123...",
  "status": "ready",
  "preview_url": "https://your-service.run.app/preview/abc123.../?token=spl_xxx"
}
```

### Embed in iframe

```html
<iframe 
  src="https://your-service.run.app/preview/abc123.../?token=spl_xxx"
  width="100%"
  height="600"
></iframe>
```

## Security Considerations

- **Access Tokens**: Each session has a unique cryptographic token required for preview access
- **Input Validation**: All inputs (repo names, refs) are sanitized against injection
- **No Arbitrary Commands**: Start commands are auto-detected, not user-specified
- **Workspace Isolation**: Each session has its own isolated directory
- **Soft Delete**: Sessions are soft-deleted for audit trail
- **RLS Enabled**: Row Level Security enabled on Supabase table

## Custom Domain Setup (Subdomain Routing)

To enable subdomain-based routing (`{session_id}.preview.yourdomain.com`), you need:

1. **Google Cloud Load Balancer** with a static IP
2. **Wildcard SSL Certificate** via Certificate Manager
3. **DNS Records**:
   - CNAME record for certificate validation
   - A record pointing `*.preview.yourdomain.com` to the load balancer IP

### Automated Setup with Terraform

The `infrastructure/terraform/` directory contains complete Terraform configuration:

```bash
cd infrastructure/terraform

# Copy and edit variables
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your project_id, preview_domain, region

# Initialize and apply
terraform init
terraform apply
```

After applying, Terraform outputs the required DNS records. Add them to your DNS provider.

### Manual Setup

See `infrastructure/terraform/README.md` for detailed manual setup instructions.

## License

MIT
